name: CICD Admin

on:
  push:
    branches:
      - dev

env:                                                          
  BRANCH: dev                                                            
  AWS_REGION: us-east-1                                                   

  GH_ADMIN_USER_NAME_PARAMETER: AP_GH_ADMIN_USER_NAME
  GH_ADMIN_USER_EMAIL_PARAMETER: AP_GH_ADMIN_USER_EMAIL
  GH_ADMIN_TOKEN_PARAMETER: AP_GH_ADMIN_TOKEN

jobs:
  cicd-admin:
    if: ${{ github.actor == 'ronfontebo' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write                                                     # This is required for requesting the JWT (OIDC)
      contents: write
      pull-requests: write
    steps:
      ###############################################################
      # CONFIGURE AWS CREDS
      ###############################################################
      - name: Configure AWS credentials
        id: configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AP_AWS_GHA_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      ###############################################################
      # CHECK GH_ADMIN_USER_NAME
      ###############################################################
      - name: Check for GH_ADMIN_USER_NAME in AWS SSM Parameter Store
        id: check-gh-admin-user-name
        if: ${{ steps.configure-aws-credentials.outcome == 'success' }}
        run: |
          aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_NAME_PARAMETER }}" \
            --query "Parameter.Value" \
            --no-with-decryption \
            --output text

          GH_ADMIN_USER_NAME_FOUND=$?

          if [[ $GH_ADMIN_USER_NAME_FOUND == '0' ]];
          then
            echo "GH_ADMIN_USER_NAME_FOUND=0" >> $GITHUB_ENV
          else
            echo "GH_ADMIN_USER_NAME_FOUND=1" >> $GITHUB_ENV

            echo "GH_ADMIN_USER_NAME not found."
          fi

      ###############################################################
      # GET GH_ADMIN_USER_NAME
      ###############################################################
      - name: Get GH_ADMIN_USER_NAME from AWS SSM Parameter Store
        id: get-gh-admin-user-name
        if: ${{ steps.check-gh-admin-user-name.outcome == 'success' && env.GH_ADMIN_USER_NAME_FOUND == '0' }}
        run: |
          echo "::add-mask::$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_NAME_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)"
          
          echo "GH_ADMIN_USER_NAME=$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_NAME_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)" >> $GITHUB_ENV

      ###############################################################
      # CHECK GH_ADMIN_USER_EMAIL
      ###############################################################
      - name: Check for GH_ADMIN_USER_EMAIL in AWS SSM Parameter Store
        id: check-gh-admin-user-email
        if: ${{ steps.get-gh-admin-user-name.outcome == 'success' }}
        run: |
          aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_EMAIL_PARAMETER }}" \
            --query "Parameter.Value" \
            --no-with-decryption \
            --output text

          GH_ADMIN_USER_EMAIL_FOUND=$?

          if [[ $GH_ADMIN_USER_EMAIL_FOUND == '0' ]];
          then
            echo "GH_ADMIN_USER_EMAIL_FOUND=0" >> $GITHUB_ENV
          else
            echo "GH_ADMIN_USER_EMAIL_FOUND=1" >> $GITHUB_ENV

            echo "GH_ADMIN_USER_EMAIL not found."
          fi

      ###############################################################
      # GET GH_ADMIN_USER_EMAIL
      ###############################################################
      - name: Get GH_ADMIN_USER_EMAIL from AWS SSM Parameter Store
        id: get-gh-admin-user-email
        if: ${{ steps.check-gh-admin-user-email.outcome == 'success' && env.GH_ADMIN_USER_EMAIL_FOUND == '0' }}
        run: |
          echo "::add-mask::$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_EMAIL_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)"
          
          echo "GH_ADMIN_USER_EMAIL=$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_USER_EMAIL_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)" >> $GITHUB_ENV

      ###############################################################
      # CHECK GH_ADMIN_TOKEN
      ###############################################################
      - name: Check for GH_ADMIN_TOKEN in AWS SSM Parameter Store
        id: check-gh-admin-token
        if: ${{ steps.get-gh-admin-user-email.outcome == 'success' }}
        run: |
          aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_TOKEN_PARAMETER }}" \
            --query "Parameter.Value" \
            --no-with-decryption \
            --output text

          GH_ADMIN_TOKEN_FOUND=$?

          if [[ $GH_ADMIN_TOKEN_FOUND == '0' ]];
          then
            echo "GH_ADMIN_TOKEN_FOUND=0" >> $GITHUB_ENV
          else
            echo "GH_ADMIN_TOKEN_FOUND=1" >> $GITHUB_ENV

            echo "GH_ADMIN_TOKEN not found."
          fi

      ###############################################################
      # GET GH_ADMIN_TOKEN
      ###############################################################
      - name: Get GH_ADMIN_TOKEN from AWS SSM Parameter Store
        id: get-gh-admin-token
        if: ${{ steps.check-gh-admin-token.outcome == 'success' && env.GH_ADMIN_TOKEN_FOUND == '0' }}
        run: |
          echo "::add-mask::$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_TOKEN_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)"
          
          echo "GH_ADMIN_TOKEN=$(aws ssm get-parameter \
            --region "${{ env.AWS_REGION }}" \
            --name "${{ env.GH_ADMIN_TOKEN_PARAMETER }}" \
            --query "Parameter.Value" \
            --with-decryption \
            --output text)" >> $GITHUB_ENV

      ###############################################################
      # CHECKOUT DEV BRANCH
      ###############################################################
      - name: Checkout Dev Branch
        id: checkout-dev-branch
        if: ${{ steps.get-slack-gha-notify-bot-token.outcome == 'success' }}
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      ###############################################################
      # GIT CONFIG USER DEV
      ############################################################### 
      - name: Git Config User Dev
        id: git-config-user-dev
        if: ${{ steps.checkout-dev-branch.outcome == 'success' }}
        run: |
          git config user.name ${{ env.GH_ADMIN_USER_NAME }}
          git config user.email ${{ env.GH_ADMIN_USER_EMAIL }}

      ###############################################################
      # GET COMMIT MSG 1
      ###############################################################
      - name: Get Commit Message 1
        id: get-commit-message-1
        if: ${{ steps.git-config-user-dev.outcome == 'success' }}  
        run: |
          echo "COMMIT_MESSAGE_1=$(echo \"${{ github.event.head_commit.message }}\")" >> $GITHUB_ENV

      ###############################################################
      # GET COMMIT MSG 2 & 3
      ###############################################################
      - name: Get commit message 2 and 3
        id: get-commit-message-2-and-3
        if: ${{ steps.get-commit-message-1.outcome == 'success' }}
        run: |
          echo "COMMIT_MESSAGE_2=${{ env.COMMIT_MESSAGE_1 }}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE_3=$(echo \"${{ env.COMMIT_MESSAGE_1 }}\")" >> $GITHUB_ENV

      ###############################################################
      # OPEN PR (GHA BOT)
      ###############################################################
      - name: Open PR
        id: open-pr
        if: ${{ steps.get-commit-message-2-and-3.outcome == 'success' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}        
        run: |
          gh pr create \
            --head "${{ env.BRANCH }}" \
            --base "main" \
            --title ${{ env.COMMIT_MESSAGE_1 }} \
            --body ${{ env.COMMIT_MESSAGE_1 }}
          
      ###############################################################
      # AUTH GH CLI
      ###############################################################          
      - name: Authenticate GitHub CLI
        id: authenticate-github-cli
        if: ${{ steps.open-pr.outcome == 'success' }}
        run: |
          echo ${{ env.GH_ADMIN_TOKEN }} | gh auth login --with-token

      ###############################################################
      # MERGE PR (REPO ADMIN)
      ###############################################################
      - name: Merge PR
        id: merge-pr
        if: ${{ steps.authenticate-github-cli.outcome == 'success' }}
        run: |
          gh pr merge --merge

      ###############################################################
      # CHECKOUT MAIN BRANCH
      ###############################################################
      - name: Checkout Main Branch
        id: checkout-main-branch
        if: ${{ steps.merge-pr.outcome == 'success' }}
        uses: actions/checkout@v4        
        with:
          repository: ${{ github.repository }}
          ref: main
          fetch-depth: 0
          token: ${{ env.GH_ADMIN_TOKEN }}

      ###############################################################
      # GIT CONFIG USER MAIN
      ############################################################### 
      - name: Git Config User Main
        id: git-config-user-main
        if: ${{ steps.checkout-main-branch.outcome == 'success' }}
        run: |
          git config user.name ${{ env.GH_ADMIN_USER_NAME }}
          git config user.email ${{ env.GH_ADMIN_USER_EMAIL }}

      ###############################################################
      # DEFINE UPDATE TYPE
      ###############################################################           
      - name: Define Update Type
        id: define-update-type
        if: ${{ steps.git-config-user-main.outcome == 'success' }}
        run: |
          define_update_type() {
            echo "Commit Message: ${{ env.COMMIT_MESSAGE_2 }}"

            echo "${{ env.COMMIT_MESSAGE_2 }}" | grep "feat-ma" > /dev/null
            MAJOR_UPDATE_FOUND=$?

            if [[ $MAJOR_UPDATE_FOUND == "0" ]];
            then
              UPDATE_TYPE_1=major
              UPDATE_TYPE_2=major
            else
              echo "${{ env.COMMIT_MESSAGE_2 }}" | grep "feat-mi" > /dev/null
              MINOR_UPDATE_FOUND=$?

              if [[ $MINOR_UPDATE_FOUND == "0" ]];
              then
                UPDATE_TYPE_1=minor
                UPDATE_TYPE_2=minor
              else
                echo "${{ env.COMMIT_MESSAGE_2 }}" | grep "bugfix" > /dev/null
                BUGFIX_UPDATE_FOUND=$?

                if [[ $BUGFIX_UPDATE_FOUND == "0" ]];
                then
                  UPDATE_TYPE_1=patch
                  UPDATE_TYPE_2=bugfix             
                else
                  echo "${{ env.COMMIT_MESSAGE_2 }}" | grep "hotfix" > /dev/null
                  HOTFIX_UPDATE_FOUND=$?

                  if [[ $HOTFIX_UPDATE_FOUND == "0" ]];
                  then
                    UPDATE_TYPE_1=patch
                    UPDATE_TYPE_2=hotfix                  
                  else
                    echo "${{ env.COMMIT_MESSAGE_2 }}" | grep "docfix" > /dev/null
                    DOCFIX_UPDATE_FOUND=$?

                    if [[ $DOCFIX_UPDATE_FOUND == "0" ]];
                    then
                      UPDATE_TYPE_1=none
                      UPDATE_TYPE_2=docfix
                    else
                      echo "|"
                      echo "| Error: Invalid commit message"
                      echo "|"
                      echo "| Commit message must follow the format '<type>/<message>'."
                      echo "| Where 'type' can be feat-ma, feat-mi, bugfix, hotfix or docfix."
                      echo "|"
                    fi
                  fi
                fi
              fi
            fi

            echo "UPDATE_TYPE_1=$UPDATE_TYPE_1" >> $GITHUB_ENV
            echo "UPDATE_TYPE_2=$UPDATE_TYPE_2" >> $GITHUB_ENV

            echo UPDATE_TYPE_1=$UPDATE_TYPE_1
            echo UPDATE_TYPE_2=$UPDATE_TYPE_2
          }

          set +e
          define_update_type
          set -e

      ###############################################################
      # UPDATE CHANGELOG
      ###############################################################  
      - name: Update changelog
        id: update-changelog
        if: ${{ steps.define-update-type.outcome == 'success' }}
        run: |
          DATE=$(date +%m-%d-%Y)

          generate_changelog_message() {
            if [[ ${{ env.UPDATE_TYPE_2 }} == "major" ]];
            then
              CHANGELOG_HEADING="Feature (Major)"
              CHANGELOG_MESSAGE=$(echo "${{ env.COMMIT_MESSAGE_2 }}" | sed -e "s|feat-ma/||")
            elif [[ ${{ env.UPDATE_TYPE_2 }} == "minor" ]];
            then
              CHANGELOG_HEADING="Feature (Minor)"
              CHANGELOG_MESSAGE=$(echo "${{ env.COMMIT_MESSAGE_2 }}" | sed -e "s|feat-mi/||")
            else
              if [[ ${{ env.UPDATE_TYPE_2 }} == "bugfix" ]];
              then
                CHANGELOG_HEADING="Patch (Bugfix)"
                CHANGELOG_MESSAGE=$(echo "${{ env.COMMIT_MESSAGE_2 }}" | sed -e "s|bugfix/||")
              elif [[ ${{ env.UPDATE_TYPE_2 }} == "hotfix" ]];
              then
                CHANGELOG_HEADING="Patch (Hotfix)"
                CHANGELOG_MESSAGE=$(echo "${{ env.COMMIT_MESSAGE_2 }}" | sed -e "s|hotfix/||")
              else
                LAST_NON_DOCFIX_COMMIT_MESSAGE=$(git log --pretty=format:"%s" | grep -v "docfix" | head -n 1)

                CHANGELOG_HEADING="Docfix"
                CHANGELOG_MESSAGE_1=$(echo "Docfix for $LAST_NON_DOCFIX_COMMIT_MESSAGE")
                CHANGELOG_MESSAGE_2=$(echo "${{ env.COMMIT_MESSAGE_2 }}" | sed -e "s|docfix/||")
              fi
            fi

            echo ""
            echo CHANGELOG_HEADING=$CHANGELOG_HEADING
            echo CHANGELOG_MESSAGE=$CHANGELOG_MESSAGE
            echo ""                  
          }
 
          update_changelog_non_docfix() {
            ls | grep CHANGELOG
            CHANGELOG_FOUND=$?

            if [[ $CHANGELOG_FOUND == "0" ]];
            then
              cat >> /tmp/CHANGELOG.md<< EOF
            # Changelog

            All notable changes to this module will be documented in this file.

            ## $CHANGELOG_HEADING ($DATE)
            * $CHANGELOG_MESSAGE

            EOF

              cp CHANGELOG.md /tmp/CHANGELOG-2.md
              sed -i '1,4d' /tmp/CHANGELOG-2.md
              echo "$(cat /tmp/CHANGELOG-2.md)" >> /tmp/CHANGELOG.md
              cat /tmp/CHANGELOG.md
              mv /tmp/CHANGELOG.md CHANGELOG.md
            else
              cat >> CHANGELOG.md<< EOF
            # Changelog

            All notable changes to this module will be documented in this file.

            ## $CHANGELOG_HEADING ($DATE)
            * $CHANGELOG_MESSAGE

            EOF
            fi
          }

          update_changelog_docfix() {
            ls | grep CHANGELOG
            CHANGELOG_FOUND=$?

            if [[ $CHANGELOG_FOUND == "0" ]];
            then
              cat >> /tmp/CHANGELOG.md<< EOF
            # Changelog

            All notable changes to this module will be documented in this file.

            ## $CHANGELOG_HEADING ($DATE)
            * $CHANGELOG_MESSAGE_1
            * $CHANGELOG_MESSAGE_2

            EOF

              cp CHANGELOG.md /tmp/CHANGELOG-2.md
              sed -i '1,4d' /tmp/CHANGELOG-2.md
              echo "$(cat /tmp/CHANGELOG-2.md)" >> /tmp/CHANGELOG.md
              cat /tmp/CHANGELOG.md
              mv /tmp/CHANGELOG.md CHANGELOG.md
            else
              cat >> CHANGELOG.md<< EOF
            # Changelog

            All notable changes to this module will be documented in this file.

            ## $CHANGELOG_HEADING ($DATE)
            * $CHANGELOG_MESSAGE_1
            * $CHANGELOG_MESSAGE_2

            EOF
            fi
          }

          set +e
          generate_changelog_message

          if [[ ${{ env.UPDATE_TYPE_2 }} != "docfix" ]];
          then
            update_changelog_non_docfix
          else
            update_changelog_docfix
          fi
          set -e

      ###############################################################
      # COMMIT $ PUSH UPDATES
      ############################################################### 
      - name: Commit and Push Updates
        id: commit-and-push-updates
        if: ${{ steps.update-changelog.outcome == 'success' }}
        run: |
          git status
          git add .
          git commit -m ${{ env.COMMIT_MESSAGE_3 }}
          git push origin

######################################## APACHEPLAYGROUND™ ########################################